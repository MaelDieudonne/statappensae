```{r include=FALSE}
# Importation des données
panel_data <- load_parquet("panel_data.parquet")
wide_panel_data <- load_parquet("wide_panel_data.parquet")
map_data <- load_shapefile("FRANCE.shx")

codes_regions <- fread("data_other/codes_regions_Insee.csv", header = TRUE)
codes_regions$ABRV <- sapply(codes_regions$LIBELLE, get_first_letters)

# Création d'un identifiant année-tour pour analyser les données wide en panel
wide_panel_data$year_round <- with(wide_panel_data, paste(year, round, sep="-"))
```

```{r}
# Définition des variables
## Outcomes
relative_outcomes <- c("part_T1", "GD_ratio_T1", "EC_ratio_T1")
relative_outcomes_2T <- c("part_T1", "part_T2", "GD_ratio_T1", "GD_ratio_T2", "EC_ratio_T1", "EC_ratio_T2")
absolute_outcomes <- c("part_T1", "GIns_ratio_T1", "DIns_ratio_T1", "EIns_ratio_T1", "CIns_ratio_T1")
absolute_outcomes_2T <- c("part_T1", "part_T2", "GIns_ratio_T1", "DIns_ratio_T1", "GIns_ratio_T2", "DIns_ratio_T2", "EIns_ratio_T1", "CIns_ratio_T1", "EIns_ratio_T2", "CIns_ratio_T2")
wide_relative_outcomes <- c("part", "GD_ratio", "EC_ratio")

## Régresseurs
## Modalités supprimées pour éviter la colinéarité : prop014, propnodip, pouvr
panel_regressors <- c("ppropri", "popcomm", "popagglo", "age", "prop1539", "prop4059", "prop60p", "propf", "propbac", "propsup", "pagri", "pindp", "pempl", "ppint", "pcadr", "pchom", "petranger", "revratio")
full_panel_regressors <- c("ppropri", "popcomm", "popagglo", "age", "prop014", "prop1539", "prop4059", "prop60p", "propf", "propnodip", "propbac", "propsup", "pagri", "pindp", "pouvr", "pempl", "ppint", "pcadr", "pchom", "petranger", "revratio")
wide_panel_regressors <- c("round", panel_regressors)
```

**Analyse des valeurs manquantes**

On vérifie facilement l'absence de valeurs manquantes pour les variables identifiantes (année et code commune).

```{r}
print(sum(is.na(panel_data$codecommune)))
print(sum(is.na(panel_data$year)))
```

Tableaux présentant la proportion de valeurs manquantes par outcome relatif, puis par régresseur, et par an.

```{r}
count_na <- function(x) mean(is.na(x)) * 100

na_table <- function(variable_names, file_name) {
  na_prop_table <- data.table(year = unique(panel_data$year))
  for (name in variable_names) {
    na_prop <- panel_data[, .(na_prop = count_na(get(name))), by = year]
    na_prop_table <- merge(na_prop_table, na_prop, by = "year", all.x = TRUE)
    setnames(na_prop_table, "na_prop", name)
  }
  
  setnames(na_prop_table, "year", "Année")
  na_prop_table[] <- lapply(na_prop_table, tidy_table)
  na_prop_table <- replace(na_prop_table, na_prop_table == 100, NA)
  
  numeric_columns <- names(na_prop_table)[-1]
  na_prop_table[, numeric_columns] <- lapply(na_prop_table[, ..numeric_columns], as.numeric)
  max_value <- max(subset(na_prop_table, select = -Année), na.rm = TRUE)
  bins <- seq(0, max_value, by = max_value/9)
  na_prop_table <- gt(na_prop_table)
  na_prop_table <- data_color(na_prop_table, method = "bin", bins = bins, columns = !starts_with("Année"), direction = "column", palette ="Oranges", na_color = "lightgrey")
  print(na_prop_table)
  gtsave(na_prop_table, filename = paste0(file_name, ".tex"), path = "output_panel")
}

na_table(relative_outcomes, "relative_outcomes_NA")
na_table(full_panel_regressors, "regressors_NA")
```

**Analyses descriptives - outcomes**

```{r}
graph_data <- data.frame(year = unique(panel_data$year))

for (outcome in relative_outcomes_2T) {
  data <- aggregate(as.formula(paste(outcome, " ~ year")), data = panel_data, FUN = mean)
  graph_data <- merge(graph_data, data, by = "year", all = TRUE)
}

graph_data$year <- as.numeric(as.character(graph_data$year))

plot <- ggplot(graph_data, aes(x = year)) +
  geom_line(aes(y = part_T1, color = "part_T1"), na.rm = TRUE) +
  geom_line(aes(y = part_T2, color = "part_T2"), na.rm = TRUE) +
  geom_line(aes(y = GD_ratio_T1, color = "GD_ratio_T1"), na.rm = TRUE) +
  geom_line(aes(y = GD_ratio_T2, color = "GD_ratio_T2"), na.rm = TRUE) +
  geom_line(aes(y = EC_ratio_T1, color = "EC_ratio_T1"), na.rm = TRUE) +
  geom_line(aes(y = EC_ratio_T2, color = "EC_ratio_T2"), na.rm = TRUE) +
  labs(title = "Outcomes relatifs, 1965-2022",
       x = "Année",
       y = "Pourcentage",
       color = "Outcomes") +
  scale_color_manual(values = c("part_T1" = "blue",
                                "part_T2" = "skyblue",
                                "GD_ratio_T1" = "limegreen",
                                "GD_ratio_T2" = "lightgreen",
                                "EC_ratio_T1" = "orange",
                                "EC_ratio_T2" = "red"),
                     labels = c("part_T1" = "Participation T1",
                                "part_T2" = "Participation T2",
                                "GD_ratio_T1" = "Ratio GD T1",
                                "GD_ratio_T2" = "Ratio GD T2",
                                "EC_ratio_T1" = "Ratio EC T1",
                                "EC_ratio_T2" = "Ratio EC T2")) +
  scale_x_continuous(breaks = unique(graph_data$year)) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    panel.grid.minor = element_blank()
  )

print(plot)
ggsave("output_panel/outcomes_relatifs_1965_2022.png", plot, width = 8, height = 6, dpi = 300)

rm(graph_data, outcome)
```

**Analyses descriptives - taux de propriétaires**

Nous pouvons d'abord représenter l'évolution du taux national de propriétaires, calculé sur l'ensemble de la population française. Il n'est cependant pas le plus pertinent, car nous allons raisonner à l'échelle des communes plutôt que des individus. Représentons donc aussi l'évolution de la proportion moyenne de propriétaires dans chaque commune.

```{r}
propri <- load_parquet("Proprietaires/proprietairescommunes.parquet")
propri_df <- data.table(year = numeric(), sum_npropri = numeric(), sum_nlogement = numeric(), prop_ratio = numeric(), ppropri = numeric())

for (year in 1960:2022) {
  col_npropri <- paste0("npropri", year)
  col_nlogement <- paste0("nlogement", year)
  col_ppropri <- paste0("ppropri", year)
  sum_npropri <- sum(propri[[col_npropri]], na.rm = TRUE)
  sum_nlogement <- sum(propri[[col_nlogement]], na.rm = TRUE)
  average_ppropri <- mean(propri[[col_ppropri]], na.rm = TRUE)
  prop_ratio <- sum_npropri / sum_nlogement
  propri_df <- rbind(propri_df, data.table(year = year, sum_npropri = sum_npropri, sum_nlogement = sum_nlogement, prop_ratio = prop_ratio, ppropri = average_ppropri))
}

plot <- ggplot(propri_df, aes(x = year)) +
  geom_line(aes(y = prop_ratio, color = "prop_ratio")) +
  geom_line(aes(y = ppropri, color = "ppropri")) +
  labs(title = "Taux de propriétaires de leur résidence principale, 1960-2022",
       x = "Année",
       y = "",
       color = "") +
  scale_color_manual(values = c("prop_ratio" = "skyblue", "ppropri" = "orange"),
                     labels = c("prop_ratio" = "Taux national", "ppropri" = "Taux communal moyen")) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
print(plot)
ggsave("output_panel/taux_proprietaires_1960_2022.png", plot, width = 8, height = 6, dpi = 300)

rm(propri, propri_df, year, col_npropri, col_nlogement, col_ppropri, sum_npropri, sum_nlogement, average_ppropri, prop_ratio)
```

La différence entre les deux courbes atteste que les propriétaires de leur résidence principale sont proportionnellement plus nombreux dans les communes de faible taille. Pour caractériser davantage cette situation, représentons l'évolution des déciles du taux communal de propriétaires. On observe une certaine convergence, avec un ratio D1/D10 qui passe de 0,5 à 0,66 sur la période.

```{r}
nb_quantiles <- 11
quantiles_list <- list()

for (yr in unique(panel_data$year)) {
  panel_subset <- panel_data[panel_data$year == yr, ]
  quantiles <- quantile(panel_subset$ppropri, probs = seq(0, 1, length.out = nb_quantiles), na.rm = TRUE)
  names(quantiles) <- paste0("D", 0:(nb_quantiles - 1))
  quantiles_list[[as.character(yr)]] <- quantiles
}

quantiles_df <- do.call(rbind, quantiles_list)
quantiles_df <- data.table(year = as.integer(row.names(quantiles_df)), quantiles_df)
quantiles_df <- melt(quantiles_df, id.vars = "year", variable.name = "quintile")
names(quantiles_df) <- c("year", "quintile", "ppropri")
quantiles_df <- quantiles_df[quantiles_df$quintile != "D0" & quantiles_df$quintile != paste0("D", nb_quantiles - 1), ]

plot <- ggplot(quantiles_df, aes(x = year, y = ppropri, color = as.factor(quintile), group = quintile)) +
  geom_line() +
  labs(title = "Déciles du taux communal moyen de propriétaires",
       x = "Année", 
       y = "", 
       color = "Déciles") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5)
  )

print(plot)
ggsave("output_panel/deciles_taux_proprietaires_1960_2022.png", plot, width = 8, height = 6, dpi = 300)

rm(nb_quantiles, quantiles_list, yr, panel_subset, quantiles, quantiles_df)
```

Étudions la corrélation du taux de propriétaires avec les autres régresseurs. Certains résultats sont peu surprenants : les propriétaires sont comparativement plus nombreux dans les communes dont les habitants sont plus âgés, et moins nombreux dans les communes plus petites et dont les habitants comptent davantage d'étrangers. Les corrélations avec le diplôme et la catégorie socio-professionnelles sont plus ambigues, avec une corrélation plus forte avec la proportion de diplômés du bac que du supérieur, et de professions intermédiaires que de cadres. On peut supposer que les diplômés du supérieur et les cadres résident davantage dans les grandes villes, ce qui freine leur accession à la propriété malgré leurs revenus supérieurs.

```{r}
panel_data_complete <- na.omit(panel_data[, c("ppropri", full_panel_regressors), with = FALSE])
correlation_results <- sapply(panel_data_complete[, -1, drop = FALSE], function(x) cor(panel_data_complete$ppropri, x))
correlation_results <- correlation_results * 100
correlation_df <- data.frame(Variables = names(correlation_results), Corrélation = correlation_results)
correlation_df <- subset(correlation_df, Variables != "ppropri")
correlation_df <- correlation_df[order(correlation_df$Corrélation, decreasing = TRUE), ]
rownames(correlation_df) <- NULL

correlation_df <- gt(correlation_df)
correlation_df <- fmt_number(correlation_df, decimals = 3, drop_trailing_zeros = TRUE)
correlation_df <- tab_header(correlation_df, "Corrélation des régresseurs avec le taux de propriétaires", subtitle = NULL, preheader = NULL)
correlation_df <- data_color(correlation_df, method = "numeric", columns = !matches("Variables"), palette ="Spectral")
correlation_df
gtsave(correlation_df, filename = "correl_ppropri.tex", path = "output_panel")

rm(panel_data_complete, correlation_results, correlation_df)
```

**Panel (premier tour seulement)**

On commence par des panels simples, en différences premières, avec clustering au niveau départemental et variance hétéroscédastique.

```{r}
# Pour les outcomes relatifs = ratios / exprimés
panel_as_pdata <- pdata.frame(panel_data, index = c("codecommune", "year"))

relative_results <- list()
for (outcome in relative_outcomes) {
  regression_formula <- as.formula(paste(outcome, "~", paste(panel_regressors, collapse = "+")))
  model_name <- paste0(outcome, "_model")
  relative_results[[model_name]] <- plm(regression_formula, data = panel_as_pdata, model = "fd", effect = "individual", cluster = "dep", vcov = "HC1")
}

suppressWarnings(stargazer(relative_results, type = "text"))
rm(model_name, regression_formula, outcome, panel_as_pdata)
```

```{r include=FALSE}
suppressWarnings(stargazer(relative_results, type = "latex", out = "output_panel/relative_panel_basic.tex"))
rm(relative_results)
```

```{r eval=FALSE}
# Pour les outcomes absolus = ratios / inscrits
panel_as_pdata <- pdata.frame(panel_data, index = c("codecommune", "year"))

absolute_results <- list()
for (outcome in absolute_outcomes) {
  regression_formula <- as.formula(paste(outcome, "~", paste(panel_regressors, collapse = "+")))
  model_name <- paste0(outcome, "_model")
  absolute_results[[model_name]] <- plm(regression_formula, data = panel_as_pdata, model = "fd", effect = "individual", cluster = "dep")
}

suppressWarnings(stargazer(absolute_results, type = "text"))
rm(model_name, regression_formula, outcome, panel_as_pdata)
```

```{r eval=FALSE, include=FALSE}
suppressWarnings(stargazer(absolute_results, type = "latex", out = "output_panel/absolute_panel_basic.tex"))
rm(absolute_results)
```

On obtient des R2 très faibles, entre 0,5 et 2,8 %, et les coefficients de ppropri, bien que significatifs, ne sont pas toujours du signe attendu. Pour remédier à ces problèmes, on essaye d'introduire des dummies annuelles.

```{r}
# Pour les outcomes relatifs = ratios / exprimés
panel_as_pdata <- pdata.frame(panel_data, index = c("codecommune", "year"))
panel_as_pdata$year <- as.factor(panel_as_pdata$year)
regressors <- c(panel_regressors, "year")

relative_results <- list()
for (outcome in relative_outcomes) {
  regression_formula <- as.formula(paste(outcome, "~", paste(regressors, collapse = "+")))
  model_name <- paste0(outcome, "_model")
  relative_results[[model_name]] <- plm(regression_formula, data = panel_as_pdata, model = "fd", effect = "individual", cluster = "dep", vcov = "HC1")
}

suppressWarnings(stargazer(relative_results, type = "text"))
rm(model_name, regression_formula, regressors, outcome, panel_as_pdata)
```

```{r include=FALSE}
suppressWarnings(stargazer(relative_results, type = "latex", out = "output_panel/relative_panel_timedummies.tex"))
rm(relative_results)
```

```{r eval=FALSE}
# Pour les outcomes absolus = ratios / inscrits
panel_as_pdata <- pdata.frame(panel_data, index = c("codecommune", "year"))
panel_as_pdata$year <- as.factor(panel_as_pdata$year)
regressors <- c(panel_regressors, "year")

absolute_results <- list()
for (outcome in absolute_outcomes) {
  regression_formula <- as.formula(paste(outcome, "~", paste(regressors, collapse = "+")))
  model_name <- paste0(outcome, "_model")
  absolute_results[[model_name]] <- plm(regression_formula, data = panel_as_pdata, model = "fd", effect = "individual", cluster = "dep", vcov = "HC1")
}

suppressWarnings(stargazer(absolute_results, type = "text"))
rm(model_name, regression_formula, regressors, outcome, panel_as_pdata)
```

```{r eval=FALSE, include=FALSE}
suppressWarnings(stargazer(absolute_results, type = "latex", out = "output_panel/absolute_panel_timedummies.tex"))
rm(absolute_results)
```

On obtient une très forte amélioration du R2, entre 21,6 et 63,9 %. Les effets de ppropri cessent d'être significatifs sur la participation. Ils le restent sur les autres outcomes, mais n'acquièrent pas de signification évidente (effet positif sur le vote à gauche, positif sur le vote au centre au T1 et négatif au T2). On teste l'hypothèse que les effets de ppropri évoluent au cours du temps en introduisant des interactions avec les dummies annuelles.

```{r}
# Pour les outcomes relatifs = ratios / exprimés
time_dummies <- model.matrix(~ year * ppropri - 1, data = panel_data)
panel_as_pdata <- pdata.frame(cbind(panel_data, time_dummies), index = c("codecommune", "year"))
panel_as_pdata$year <- as.factor(panel_as_pdata$year)

regressors <- c(panel_regressors, colnames(time_dummies))
regressors <- regressors[regressors != "ppropri"]

relative_results <- list()
for (outcome in relative_outcomes) {
  regression_formula <- as.formula(paste(outcome, "~", paste(regressors, collapse = "+")))
  model_name <- paste0(outcome, "_model")
  relative_results[[model_name]] <- plm(regression_formula, data = panel_as_pdata, model = "fd", effect = "individual", cluster = "dep", vcov = "HC1")
}

suppressWarnings(stargazer(relative_results, type = "text"))
rm(model_name, regression_formula, regressors, time_dummies, outcome, panel_as_pdata)
```

```{r}
part_T1 <- as.data.frame(relative_results$part_T1_model$coefficients)
part_T1 <- part_T1[grep("ppropri$", rownames(part_T1)), , drop = FALSE]
colnames(part_T1) <- "coef_ppropri"
years <- sub("^year(\\d+):.*", "\\1", rownames(part_T1))
part_T1$year <- years
part_T1$outcome <- "part_T1"

GD_ratio_T1 <- as.data.frame(relative_results$GD_ratio_T1_model$coefficients)
GD_ratio_T1 <- GD_ratio_T1[grep("ppropri$", rownames(GD_ratio_T1)), , drop = FALSE]
colnames(GD_ratio_T1) <- "coef_ppropri"
years <- sub("^year(\\d+):.*", "\\1", rownames(GD_ratio_T1))
GD_ratio_T1$year <- years
GD_ratio_T1$outcome <- "GD_ratio_T1"

EC_ratio_T1 <- as.data.frame(relative_results$EC_ratio_T1_model$coefficients)
EC_ratio_T1 <- EC_ratio_T1[grep("ppropri$", rownames(EC_ratio_T1)), , drop = FALSE]
colnames(EC_ratio_T1) <- "coef_ppropri"
years <- sub("^year(\\d+):.*", "\\1", rownames(EC_ratio_T1))
EC_ratio_T1$year <- years
EC_ratio_T1$outcome <- "EC_ratio_T1"

coefficients <- rbind(part_T1, GD_ratio_T1, EC_ratio_T1)

plot <- ggplot(coefficients, aes(x = year, y = coef_ppropri, color = outcome, group = outcome)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgrey") + 
  labs(title = "Coefficients de ppropri dans les panels", subtitle = "(avec interactions temporelles)",
       x = "Année",
       y = "Coefficient",
       color = "Outcome") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))
print(plot)
ggsave("output_panel/ppropri_panel_coeffs.png", plot, width = 8, height = 6, dpi = 300)

rm(part_T1, GD_ratio_T1, EC_ratio_T1, coefficients, years, plot)
```

```{r include=FALSE}
suppressWarnings(stargazer(relative_results, type = "latex", out = "output_panel/relative_panel_timedummies_interactions.tex"))
rm(relative_results)
```

```{r eval=FALSE}
# Pour les outcomes absolus = ratios / inscrits
time_dummies <- model.matrix(~ year * ppropri - 1, data = panel_data)
panel_as_pdata <- pdata.frame(cbind(panel_data, time_dummies), index = c("codecommune", "year"))
panel_as_pdata$year <- as.factor(panel_as_pdata$year)

regressors <- c(panel_regressors, colnames(time_dummies))
regressors <- regressors[regressors != "ppropri"]

absolute_results <- list()
for (outcome in absolute_outcomes) {
  regression_formula <- as.formula(paste(outcome, "~", paste(regressors, collapse = "+")))
  model_name <- paste0(outcome, "_model")
  absolute_results[[model_name]] <- plm(regression_formula, data = panel_as_pdata, model = "fd", effect = "individual", cluster = "dep", vcov = "HC1")
}

suppressWarnings(stargazer(absolute_results, type = "text"))
rm(model_name, regression_formula, regressors, time_dummies, outcome, panel_as_pdata)
```

```{r eval=FALSE, include=FALSE}
suppressWarnings(stargazer(absolute_results, type = "latex", out = "output_panel/absolute_panel_timedummies_interactions.tex"))
rm(absolute_results)
```

Les R2 n'évoluent pas. Pratiquement tous les sous-coefficients de ppropri sont significatifs, mais ils fluctuent d'une manière qui les rend difficilement interprétables.

**Panel avec tours confondus**

Première tentative simple : comme précédemment, on obtient des R2 très faibles, bien que marginalement meilleurs.

```{r}
# Pour les outcomes relatifs = ratios / exprimés
wide_panel_as_pdata <- pdata.frame(wide_panel_data, index = c("codecommune", "year_round"))

relative_results <- list()
for (outcome in wide_relative_outcomes) {
  regression_formula <- as.formula(paste(outcome, "~", paste(wide_panel_regressors, collapse = "+")))
  model_name <- paste0(outcome, "_model")
  relative_results[[model_name]] <- plm(regression_formula, data = wide_panel_as_pdata, model = "fd", effect = "individual", cluster = "dep", vcov = "HC1")
}

suppressWarnings(stargazer(relative_results, type = "text"))
rm(model_name, regression_formula, outcome, wide_panel_as_pdata)
```

```{r include=FALSE}
suppressWarnings(stargazer(relative_results, type = "latex", out = "output_panel/relative_widepanel_basic.tex"))
rm(relative_results)
```

Seconde tentative avec dummies temporelles

```{r}
# Pour les outcomes relatifs = ratios / exprimés
wide_panel_as_pdata <- pdata.frame(wide_panel_data, index = c("codecommune", "year_round"))
wide_panel_as_pdata$year <- as.factor(wide_panel_as_pdata$year)

regressors <- c(wide_panel_regressors, "year")

relative_results <- list()
for (outcome in wide_relative_outcomes) {
  regression_formula <- as.formula(paste(outcome, "~", paste(regressors, collapse = "+")))
  model_name <- paste0(outcome, "_model")
  relative_results[[model_name]] <- plm(regression_formula, data = wide_panel_as_pdata, model = "fd", effect = "individual", cluster = "dep", vcov = "HC1")
}

suppressWarnings(stargazer(relative_results, type = "text"))
rm(model_name, regression_formula, regressors, outcome, wide_panel_as_pdata)
```

```{r include=FALSE}
suppressWarnings(stargazer(relative_results, type = "latex", out = "output_panel/relative_widepanel_timedummies.tex"))
rm(relative_results)
```

Troisième tentative avec dummies temporelles et interactions

```{r}
# Pour les outcomes relatifs = ratios / exprimés
time_dummies <- model.matrix(~ year * ppropri - 1, data = wide_panel_data)
wide_panel_as_pdata <- pdata.frame(cbind(wide_panel_data, time_dummies), index = c("codecommune", "year_round"))
wide_panel_as_pdata$year <- as.factor(wide_panel_as_pdata$year)

regressors <- c(wide_panel_regressors, colnames(time_dummies))
regressors <- regressors[regressors != "ppropri"]

relative_results <- list()
for (outcome in wide_relative_outcomes) {
  regression_formula <- as.formula(paste(outcome, "~", paste(regressors, collapse = "+")))
  model_name <- paste0(outcome, "_model")
  relative_results[[model_name]] <- plm(regression_formula, data = wide_panel_as_pdata, model = "fd", effect = "individual", cluster = "dep", vcov = "HC1")
}

suppressWarnings(stargazer(relative_results, type = "text"))
rm(model_name, regression_formula, regressors, time_dummies, outcome, wide_panel_as_pdata)
```

```{r}
part_T1 <- as.data.frame(relative_results$part_model$coefficients)
part_T1 <- part_T1[grep("ppropri$", rownames(part_T1)), , drop = FALSE]
colnames(part_T1) <- "coef_ppropri"
years <- sub("^year(\\d+):.*", "\\1", rownames(part_T1))
part_T1$year <- years
part_T1$outcome <- "part_T1"

GD_ratio_T1 <- as.data.frame(relative_results$GD_ratio_model$coefficients)
GD_ratio_T1 <- GD_ratio_T1[grep("ppropri$", rownames(GD_ratio_T1)), , drop = FALSE]
colnames(GD_ratio_T1) <- "coef_ppropri"
years <- sub("^year(\\d+):.*", "\\1", rownames(GD_ratio_T1))
GD_ratio_T1$year <- years
GD_ratio_T1$outcome <- "GD_ratio_T1"

EC_ratio_T1 <- as.data.frame(relative_results$EC_ratio_model$coefficients)
EC_ratio_T1 <- EC_ratio_T1[grep("ppropri$", rownames(EC_ratio_T1)), , drop = FALSE]
colnames(EC_ratio_T1) <- "coef_ppropri"
years <- sub("^year(\\d+):.*", "\\1", rownames(EC_ratio_T1))
EC_ratio_T1$year <- years
EC_ratio_T1$outcome <- "EC_ratio_T1"

coefficients <- rbind(part_T1, GD_ratio_T1, EC_ratio_T1)

plot <- ggplot(coefficients, aes(x = year, y = coef_ppropri, color = outcome, group = outcome)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgrey") + 
  labs(title = "Coefficients de ppropri dans les panels", subtitle = "(avec interactions temporelles et indicatrice des tours)",
       x = "Année",
       y = "Coefficient",
       color = "Outcome") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))
print(plot)
ggsave("output_panel/ppropri_panel_coeffs_round_dummies.png", plot, width = 8, height = 6, dpi = 300)

rm(part_T1, GD_ratio_T1, EC_ratio_T1, coefficients, years, plot)
```

```{r include=FALSE}
suppressWarnings(stargazer(relative_results, type = "latex", out = "output_panel/relative_widepanel_timedummies_interactions.tex"))
rm(relative_results)
```

**Régressions annuelles**

On peut confirmer le constat d'une variabilité des effets de ppropri en réalisant des régressions années par années, et en traçant l'évolution de son coefficient. La différence avec les panels précédents est que les coefficients des autres variables sont désormais libres au cours du temps ?

```{r}
results <- data.frame(year = integer(), "part_T1" = numeric(), "part_T2" = numeric(), "GD_ratio_T1" = numeric(), "GD_ratio_T2" = numeric(), "EC_ratio_T1" = numeric(), "EC_ratio_T2" = numeric(), "R2_adj" = numeric())

for (outcome in relative_outcomes) {
  for (yr in unique(panel_data$year)) {
    subset_data <- panel_data[panel_data$year == yr, ]
    regression_formula <- as.formula(paste(outcome, "~", paste(panel_regressors, collapse = "+")))
    tryCatch({
      model <- lm(regression_formula, data = subset_data)
      results <- rbind(results, data.frame(outcome = outcome, year = yr, coef_ppropri = coef(model)["ppropri"], r2_adj = summary(model)$adj.r.squared))
      }, error = function(e) {
        results <- rbind(results, data.frame(outcome = outcome, year = yr, coef_ppropri = NA, r2_adj = NA))
    })
  }
}

ggplot(results, aes(x = year, y = r2_adj, color = outcome, group = outcome)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgrey") + 
  labs(title = "R2 ajusté des régressions annuelles",
       x = "Année",
       y = "R2 ajusté",
       color = "Outcome") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(results, aes(x = year, y = coef_ppropri, color = outcome, group = outcome)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgrey") + 
  labs(title = "Coefficients de pprori dans les régressions annuelles",
       x = "Année",
       y = "Coefficient",
       color = "Outcome") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

rm(results, outcome, yr, subset_data, regression_formula, model)
```

Régressions pseudo-quantiles (considérant les quantiles de ppropri plutôt que de l'outcome)

```{r}
# Possibilité 1 : considérer la distribution relative avec les quantiles années par année
pseudo_quant_reg <- function(outcome) {
  coefs_df <- data.frame(year = integer(), quantile = character(), coefficient = numeric())
  R2_df <- data.frame(year = integer(), quantile = character(), R2 = numeric())
  regression_formula <- as.formula(paste(outcome, "~", paste(panel_regressors, collapse = "+")))
  
  for (yr in unique(panel_data$year)) {
    panel_subset <- panel_data[panel_data$year == yr, ]
    quantiles <- quantile(panel_subset$ppropri, probs = seq(0, 1, by = 0.25), na.rm = TRUE)
    for (i in 1:(length(quantiles) - 1)) {
      quantile_subset <- panel_subset[panel_subset$ppropri >= quantiles[i] & panel_subset$ppropri <= quantiles[i + 1], ]
      model <- lm(regression_formula, data = quantile_subset)
      coefs_df <- rbind(coefs_df, data.frame(year = yr, quantile = paste(i), coefficient = model$coef["ppropri"]))
      R2_df <- rbind(R2_df, data.frame(year = yr, quantile = paste(i), R2 = summary(model)$adj.r.squared))
    }
  }

  plot_r2 <- ggplot(R2_df, aes(x = factor(year), y = R2, color = quantile, group = quantile)) +
    geom_line() +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgrey") + 
    labs(title = paste("R2 des régressions pseudo-quantiles de", outcome), subtitle ="(quantiles variables)",
         x = "Année",
         y = "R2") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))
  print(plot_r2)
  
  plot_coef <- ggplot(coefs_df, aes(x = factor(year), y = coefficient, color = quantile, group = quantile)) +
    geom_line() +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgrey") + 
    labs(title = paste("Coefficients de ppropri dans les régressions pseudo-quantiles de", outcome), subtitle ="(quantiles variables)",
         x = "Année",
         y = "Coefficient") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))
  print(plot_coef)
}

for (outcome in relative_outcomes) {pseudo_quant_reg(outcome)}

rm(pseudo_quant_reg, outcome)
```

```{r}
# Possibilité 2 : considérer les niveaux absolus
pseudo_quant_reg <- function(outcome) {
  coefs_df <- data.frame(year = integer(), quantile = character(), coefficient = numeric())
  R2_df <- data.frame(year = integer(), quantile = character(), R2 = numeric())
  regression_formula <- as.formula(paste(outcome, "~", paste(panel_regressors, collapse = "+")))
  
  ppropri_ranges <- list("< 50 %" = c(0, 50),
                         "50-60 %" = c(50, 60),
                         "60-70 %" = c(60, 70),
                         "70-80 %" = c(70, 80),                       
                         "80-90 %" = c(80, 90),                       
                         "90 % <" = c(90, Inf))
  
  for (yr in unique(panel_data$year)) {
    panel_subset <- panel_data[panel_data$year == yr, ]
    for (range_name in names(ppropri_ranges)) {
      range_values <- ppropri_ranges[[range_name]]
      subset_name <- paste(range_name)
      quantile_subset <- panel_subset[panel_subset$ppropri >= range_values[1] & panel_subset$ppropri < range_values[2], ]
      if (nrow(quantile_subset) > 0) {
        model <- lm(regression_formula, data = quantile_subset)
        coefs_df <- rbind(coefs_df, data.frame(year = yr, quantile = subset_name, coefficient = model$coef["ppropri"]))
        R2_df <- rbind(R2_df, data.frame(year = yr, quantile = subset_name, R2 = summary(model)$adj.r.squared))
      }
    }
  }
  
  plot_r2 <- ggplot(R2_df, aes(x = factor(year), y = R2, color = quantile, group = quantile)) +
    geom_line() +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgrey") + 
    labs(title = paste("R2 des régressions pseudo-quantiles de", outcome), subtitle ="(quantiles absolus)",
         x = "Année",
         y = "R2") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))
  print(plot_r2)
  
  plot_coef <- ggplot(coefs_df, aes(x = factor(year), y = coefficient, color = quantile, group = quantile)) +
    geom_line() +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgrey") + 
    labs(title = paste("Coefficients de ppropri dans les régressions pseudo-quantiles de", outcome), subtitle ="(quantiles absolus)",
         x = "Année",
         y = "Coefficient") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))
  print(plot_coef)
}

for (outcome in relative_outcomes) {pseudo_quant_reg(outcome)}

rm(pseudo_quant_reg, outcome)
```

Régressions quantiles

```{r}
quant_reg <- function(outcome) {
  coefs_df <- data.frame(year = integer(), coefficient = numeric(), quantile = numeric())
  R2_df <- data.frame(year = integer(), R2 = numeric(), quantile = numeric())
  regression_formula <- as.formula(paste(outcome, "~", paste(panel_regressors, collapse = "+")))

  quantiles <- c(0.2, 0.4, 0.6, 0.8)
    
  for (yr in unique(panel_data$year)) {
    subset_data <- panel_data[panel_data$year == yr, ]
    for (q in quantiles) {
      model <- rq(regression_formula, data = subset_data, tau = q)
      coefs_df <- rbind(coefs_df, data.frame(year = yr, coefficient = coef(model)["ppropri"], quantile = q))
    }
  }
  
  plot_coef <- ggplot(coefs_df, aes(x = year, y = coefficient, color = factor(quantile))) +
    geom_line() +
    geom_point() +
    geom_hline(yintercept = 0, linetype = "dashed", color = "darkgrey") + 
    labs(title = paste("Coefficients de ppropri dans les régressions quantiles de", outcome),
         x = "Année", y = "Coefficient") +
    scale_color_discrete(name = "Quantile") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5))
  print(plot_coef)
}

for (outcome in relative_outcomes) {quant_reg(outcome)}

rm(quant_reg, outcome)
```
